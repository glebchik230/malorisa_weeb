<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Админ-панель</title>
  <script src="https://cdn.backendless.com/js/6.8.1/backendless.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9f0f7;
      padding: 20px;
      color: #333;
      max-width: 700px;
      margin: auto;
    }
    h2 {
      color: #cc6699;
    }
    select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background-color: #cc6699;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #b35588;
    }
    #notifications {
      margin-top: 30px;
      background: white;
      padding: 15px;
      border-radius: 15px;
      max-height: 250px;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(204,102,153,0.3);
    }
    #notifications h3 {
      margin-top: 0;
      color: #cc6699;
    }
    .notification-item {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
    .notification-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <h2>Админ-панель</h2>
   <button id="backBtn" style="
    background: none; 
    border: none; 
    color: #cc6699; 
    font-size: 18px; 
    cursor: pointer; 
    margin-bottom: 20px;
    padding: 0;
  ">← Назад</button>

  <label for="userSelect">Выберите пользователя:</label>
  <select id="userSelect">
    <option value="">Загрузка пользователей...</option>
  </select>

  <label for="messageType">Тип сообщения:</label>
  <select id="messageType">
    <option value="похвала">Похвала</option>
    <option value="выговор">Выговор</option>
  </select>

  <label for="messageText">Текст сообщения:</label>
  <textarea id="messageText" rows="4" placeholder="Введите текст сообщения"></textarea>

  <button id="sendMessageBtn">Отправить сообщение</button>

  <div id="notifications">
    <h3>Уведомления о новых регистрациях</h3>
    <div id="registrationNotifications">Загрузка...</div>
  </div>

  <script>
    const APP_ID = 'DCA33B47-8058-4798-8EFA-40BE7FDE1DB3';
    const API_KEY = '433B51A9-0249-48FE-96EF-C94A139DD378';
    const ADMIN_PHONE = '9004163928';

    Backendless.initApp(APP_ID, API_KEY);
document.getElementById('backBtn').addEventListener('click', () => {
  window.location.href = 'index.html';
});

    async function loadUsers() {
      try {
        const users = await Backendless.Data.of('User').find();
        const userSelect = document.getElementById('userSelect');
        userSelect.innerHTML = '<option value="">-- Выберите пользователя --</option>';
        users.forEach(user => {
          if(user.phone !== ADMIN_PHONE) {
            userSelect.innerHTML += `<option value="${user.objectId}" data-phone="${user.phone}">${user.phone} — ${user.email || ''}</option>`;
          }
        });
      } catch (error) {
        alert('Ошибка при загрузке пользователей: ' + error.message);
      }
    }

    async function loadRegistrationNotifications() {
      try {
        const notifications = await Backendless.Data.of('Notifications').find({
          whereClause: `type = 'регистрация'`,
          sortBy: ['created DESC']
        });
        const container = document.getElementById('registrationNotifications');
        if(notifications.length === 0) {
          container.innerHTML = '<p>Нет новых регистраций</p>';
          return;
        }
        container.innerHTML = '';
        notifications.forEach(n => {
          container.innerHTML += `<div class="notification-item">${n.message} <small>(${new Date(n.created).toLocaleString()})</small></div>`;
        });
      } catch (error) {
        alert('Ошибка при загрузке уведомлений: ' + error.message);
      }
    }

    async function sendMessage() {
      const userSelect = document.getElementById('userSelect');
      const messageType = document.getElementById('messageType').value;
      const messageText = document.getElementById('messageText').value.trim();

      if (!userSelect.value) {
        alert('Пожалуйста, выберите пользователя');
        return;
      }
      if (!messageText) {
        alert('Введите текст сообщения');
        return;
      }

      try {
        // Получаем выбранного пользователя
        const userId = userSelect.value;
        const user = await Backendless.Data.of('User').findById(userId);

        // Сохраняем уведомление для пользователя
        const notification = {
          recipientPhone: user.phone,
          message: messageText,
          type: messageType
        };
        await Backendless.Data.of('Notifications').save(notification);

        // Обновляем рейтинг пользователя
        let newRating = user.rating || 0;
        if(messageType === 'похвала') newRating++;
        else if(messageType === 'выговор') newRating--;

        await Backendless.Data.of('User').save({...user, rating: newRating});

        alert('Сообщение отправлено');
        document.getElementById('messageText').value = '';
        loadUsers();
        loadRegistrationNotifications();
      } catch (error) {
        alert('Ошибка при отправке сообщения: ' + error.message);
      }
    }

    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);

    loadUsers();
    loadRegistrationNotifications();
  </script>
</body>
</html>




